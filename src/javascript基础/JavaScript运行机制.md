# JavaScript运行机制

- 代码执行
    - 同步
    - 异步
        - 微任务
        - 宏任务

> 单线程

js引擎 解析执行 JavaScript代码的进程只有1个，也就是主线程

此外还有其他线程：dom线程，ajax线程，文件线程。

> 三个相关队列 【FIFO 先进先出有顺序】

- 主任务队列 main queue
    - 被执行栈优先调用
- 任务队列 job queue（promise）
    - Promise构造函数内部会 立即执行
    - resolve reject 的函数会在主任务队列中没有任务后才加入到主任务中执行
    - Promise.then catch finally、process.nextTick
    - 微任务 
- 消息队列 message queue
    - setTimeout >=4ms
    - setInterval >=4ms
    - 事件回调
    - I/O 、setTimeout、setInterval
    - 宏任务


> 执行过程

- 主线程常常执行代码
- 异步代码（setTimeout，Promise， http）时，浏览器开启对应的线程，js引擎会继续执行下面的代码
- 主线程的任务代码执行完毕后  **事件触发线程** 会从消息队列中取出一个任务（循环的过程）
- 其他的各个异步线程会在满足条件的时机会被 **事件触发线程** 将其回调函数加入到消息队列的末尾


- 主线程中没有任务时才会执行异步代码
- 低优先级队列任务执行完毕后会询问高优先级任务队列是否为空


主线程程序执行，调用栈，执行到异步代码还是会正常执行，开启别的非js异步线程如定时器，http，然后是怎么样的呢？两种情况： 1与此同时将回调函数注册到消息队列 2在得到结果后才将回调函数插入消息队列 （如果存在任务状态）

> 事件循环 

主线程代码执行完毕后不断循环请求消息队列的过程

> 浏览器内核的常驻3个线程

- js引擎
- gui渲染进程 
    - gui 处理重绘重排
    - 与js引擎是互斥关系
    - js执行过程中有视图变化会存入视图更新队列，等js执行完毕后才开始渲染
    - 渲染过程中如果执行有事件呢？？
- 事件触发进程 - 点击，回调等等，将任务加入到队列的后面，等待js引擎执行
- http请求线程（不是一直都在）
- 定时器线程
